# 指针

---

我们之间花很大的篇幅介绍了各种 C 语言和 C++语言的数据类型，指针类型是一种特殊的数据类型，它用来存储一个变量的地址。

在创建一个变量的时候，编译器会自动地为这个变量分配一块内存，然后把变量本身绑定给一个符号（变量名），因此，我们可以认为一般变量是对内存的直接引用，而指针类型是对该变量所在内存地址的引用。

> 内存地址是一个无符号整数，它表示内存中的一个位置。在 32 位系统中，一个内存地址通常是一个 32 位的整数，而在 64 位系统中，一个内存地址通常是一个 64 位的整数。

具体关系可以参考下图：

![指针](./assets/07/pointer.png)

## 声明一个指针

要声明一个指针，我们需要使用符号 `*`：

```c

int value = 42; // 声明一个 int 类型的变量 value，并初始化为 42
int* p = &value; // 声明一个 int 类型的指针 p，并初始化为 value 的地址

```

上面，我们使用了取地址运算符 `&` 来获取变量 `value` 的地址，然后把这个地址赋值给指针 `p`。

同时，C 语言中还预定义了一个特殊的宏 `NULL`，它表示一个空指针：

```c

int* p = NULL; // 声明一个 int 类型的指针 p，并初始化为 NULL

```

此时，指针 `p` 指向了一个空地址，它不指向任何有效的内存单元，在这种情况下，我们不能使用指针 `p` 来访问它所指向的值，因为它根本就没有指向任何值。

> 在 C++ 中，请使用 `nullptr` 来代替 `NULL`，这是因为 `NULL` 是一个宏定义，而 `nullptr` 是一个关键字，它具有更好的类型安全性。

## 访问指针指向的值

我们可以使用取值运算符 `*` 来访问指针所指向的值：

```c

int value = 42;
int* p = &value;

printf("%d\n", *p); // 输出 42
printf("%p\n", p); // 输出 value 的地址

```

如果我们用指针指向了一个结构体，我们可以使用 `->` 来访问结构体的成员：

```c

struct Point {
    int x;
    int y;
};

struct Point p = {1, 2};
struct Point* pp = &p;

printf("%d\n", pp->x); // 输出 1

```

指针可以指向几乎任何类型的数据，并且，在指向部分特殊类型的数据时，指针可以进行算术运算，但该部分内容超出了本课程的范围，这里不会进行详细介绍。

## 手动分配内存

之前，我们让指针指向了一个已经存在的变量，这些由编译器自动分配内存的变量通常存储在栈内存中，由编译器统一管理。

此外，我们可以手动在名为堆内存的内存区域中分配内存，这样的内存由程序员手动管理，我们可以使用 `malloc` 和 `free` 来进行堆内存的分配和释放。

要使用这两个函数，需要引入头文件 `stdlib.h`：

```c

#include <stdlib.h>

int main() {
    int* p = (int*)malloc(sizeof(int)); // 分配一个 int 类型的内存空间
    *p = 42; // 把 42 存储到 p 所指向的内存空间
    free(p); // 释放 p 所指向的内存空间
    return 0;
}

```

上面的代码中，我们使用了 `malloc` 来分配一个 `int` 类型的内存空间，然后使用 `free` 来释放这个内存空间。

这里我们使用了使用了类型转换符 `(int*)`，我们可以在任何表达式前面加上一个类型转换符，来把表达式的类型转换为我们需要的类型。但需要保证二者之间的转换是可行的。

`sizof` 是一个关键字，它用来获取一个类型的大小，它的参数可以是一个类型名，也可以是一个表达式。

## C++ 手动分配内存

在 C++ 中，我们可以使用 `new` 和 `delete` 来进行堆内存的分配和释放：

```c++

int* p = new int(42); // 分配一个 int 类型的内存空间，并初始化为 42
delete p; // 释放 p 所指向的内存空间

```

`new` 和 `delete` 是 C++ 中的关键字，它们具有更好的类型安全性，而且不需要使用类型转换符。

> 更重要的是，这两个关键字对`class`类型的对象进行了特殊处理，会自动调用构造函数和析构函数。

## 练习

​	回顾我们刚刚所讲的，内存管理是C/C++中一个重大的topic，请完成以下练习：

> 1. 声明，传递与访问指针：
>
> > 你需要写一个可以计算一个数的平方的函数，今规定它的签名必须为：
> >
> > ```
> > int calc_square(int* someNumber);
> > ```
> >
> > 请实现这个函数并且使用它计算5的平方值，打印在控制台上。
>
> 2. 学习在堆上完成内存管理
>
> 分别使用C语言，C++语言完成：
>
> > 1. 尝试在堆上开辟一个可以恰好存放10个int类型的数组，且将他初始化为0, 1, 2, ..., 9。
> > 2. 书写函数`void printHeapArray(const int* arrBegin, int arrSize)`，打印这个数组
> > 3. 释放这个数组

[参考答案请点击这里](../../code/exercise/Exercise_07.md)
