# 宏与预处理器

---

我们从第一节课就开始使用`#include`这个预处理指令来引入文件，在这一节，我们将统一介绍预处理器的相关内容。

## 预处理器

预处理器是 C 语言的重要部分，它在代码编译成可执行程序之间就被编译器进行处理，故名预处理器。

预处理经常被用来直接对源代码进行操作，它们以 `#` 开头，比如 `#include`、`#define` 等，下面我们将介绍一些常用的预处理指令。

## `#include`

`#include` 是预处理指令，它用来引入头文件。在 C 语言中，头文件通常包含了一些函数声明、宏定义、结构体声明等。

实际上，`#include` 将会在编译时将目标文件的所有内容复制到当前文件中，以达到引入目标文件的目的。

也就是说，`#include` 是一个简单的文本替换操作，它并不在乎引入的文件是什么类型的文件，只要它是一个文本文件就可以。

下面是一个简单的 `#include` 的例子：

```c

#include <stdio.h> // 引入标准输入输出库的头文件
#include "myheader.h" // 引入自定义头文件

```

上文中，我们以两种方式引入了头文件，使用尖括号引入会优先搜索系统目录，而使用双引号引入会优先搜索源代码所在目录。

## `#define`

`#define` 是预处理指令，它用来定义宏。

宏是一种简单的替换操作，它会在编译时将宏名替换为宏值，比如：

```c

#define PI 3.1415926

```

如果我们在代码中使用了 `PI`，那么它将会在编译时被替换为 `3.1415926`。

因为是直接对源代码进行操作，所以宏值可以是任何内容，比如：

```c

#define CODE printf("Hello, world!\n");


int main() {
    CODE
    return 0;
}

```

这样的操作也是被允许的，但我们并不推荐这样的操作，因为它会使代码变得难以阅读！

合理的使用宏可以简化代码，但过度的使用宏会使代码变得难以阅读和维护，所以我们应该谨慎使用宏。

宏还有一些高级使用方法，这里并不做详细介绍，你可以参考[宏](https://zh.cppreference.com/w/c/preprocessor)。

## `#undef`

`#undef` 是预处理指令，它用来取消宏定义。

如果我们在代码中使用了 `#define` 定义了一个宏，那么我们可以使用 `#undef` 来取消这个宏的定义，比如：

```c

#define PI 3.1415926

#undef PI // 取消宏 PI 的定义 从此处开始，PI 不再是宏

```

## `#ifdef`、`#ifndef`、`#endif`

`#ifdef`、`#ifndef`、`#endif` 是预处理指令，它们用来进行条件编译。

`#ifdef` 是 `#if defined` 的缩写，它用来判断一个宏是否被定义，如果被定义，那么它后面的代码将会被编译，比如：

```c

#ifdef PI
    printf("PI is defined!\n");
#endif

```

`#ifndef` 是 `#if !defined` 的缩写，它用来判断一个宏是否没有被定义，如果没有被定义，那么它后面的代码将会被编译，比如：

```c

#ifndef PI
    printf("PI is not defined!\n");
#endif

```

`#endif` 用来结束 `#ifdef`、`#ifndef` 的条件编译，它没有参数，只是一个结束标记。

## `#if`、`#elif`、`#else`

`#if`、`#elif`、`#else` 是预处理指令，它们用来进行条件编译。

`#if` 用来判断一个表达式是否为真，如果为真，那么它后面的代码将会被编译，比如：

```c

#if 1
    printf("1 is true!\n");
#endif

```

`#elif` 是 `#else if` 的缩写，它用来判断一个表达式是否为真，如果为真，那么它后面的代码将会被编译，比如：

```c

#if 0
    printf("0 is true!\n");
#elif 1
    printf("1 is true!\n");
#endif

```

`#else` 用来判断前面的条件是否为假，如果为假，那么它后面的代码将会被编译，比如：

```c

#if 0
    printf("0 is true!\n");
#else
    printf("0 is false!\n");
#endif

```

注意，预处理指令的条件只能是编译时常量，不能使用变量。

## `#error`

`#error` 是预处理指令，它用来生成一个错误信息，比如：

```c

#if 0
    printf("0 is true!\n");
#else
    #error "0 is false!"
#endif

```

上面的代码将会在编译时生成一个错误信息，这个错误信息是由 `#error` 后面的字符串决定的。

## 更多预处理指令

除了上面介绍的预处理指令，C 语言还有很多其他的预处理指令，这里不做详细介绍，你可以参考[预处理指令](https://zh.cppreference.com/w/c/preprocessor)。

## 练习

​	嵌入式开发中，预处理指令常常是无处不在的。系统学习预处理指令也是我们迈向多文件工程编程的第一步。从现在开始，不应当把所有的代码放在一个文件而是根据模块分到不同的文件当中。如何科学的分类仍需要大量的训练。

​	另一方面，#define, #if, #ifdef, #ifndef等指令可以在执行前控制代码如何编译，我们可以调整被define量来控制代码如何被编译

​	现在，请你使用刚刚学习到的知识，解释以下代码的行为

```C
// myheader.h
#ifndef _DEMO_H_
#define _DEMO_H_
#include <stdlib.h>

#define _USE_MALLOC_ 1 // 我们在这里做了什么？
#if _USE_MALLOC_
#define 	ALLOCATE_AN_INT 	(int*)malloc(sizeof(int))
#else
#define 	ALLOCATE_AN_INT 	(int*)calloc(1, sizeof(int)) // calloc, 可以网上查阅这个函数
#endif // _DEMO_H_
```

```c++
// main.cpp
// TIPS: 
// 对于自己的头文件使用""括起来
// 对于标准库使用<>括起来
#include "myheader.h"
#include <stdio.h>

int main()
{
    int* demo = ALLOCATE_AN_INT; // 你认为这里的ALLOCATE_AN_INT是什么？
    *demo = 1;
    printf("%d\n", *demo);
    free(demo);
}
```

